public <T extends OrganizationScoped> T setOrganization(T entity) {
        if (entity == null) {
            throw new IllegalArgumentException("Entity cannot be null");
        }

        UUID organizationId = OrganizationContext.getCurrentOrganizationId();
        Organization organization = entityManager.getReference(Organization.class, organizationId);
        entity.setOrganization(organization);

        log.debug("Organization set on entity: {} - orgId={}",
            entity.getClass().getSimpleName(), organizationId);

        return entity;
    }

    /**
     * Sets organization on an entity, or uses a specific organization ID if provided.
     * Useful for admin operations or bulk imports.
     *
     * @param entity the entity
     * @param organizationId specific organization ID (null to use context)
     * @param <T> entity type
     * @return the entity with organization set
     */
    public <T extends OrganizationScoped> T setOrganization(T entity, UUID organizationId) {
        if (entity == null) {
            throw new IllegalArgumentException("Entity cannot be null");
        }

        UUID orgId = organizationId != null ? organizationId : OrganizationContext.getCurrentOrganizationId();
        Organization organization = entityManager.getReference(Organization.class, orgId);
        entity.setOrganization(organization);

        log.debug("Organization set on entity: {} - orgId={}",
            entity.getClass().getSimpleName(), orgId);

        return entity;
    }

    /**
     * @deprecated Use {@link #setOrganization(OrganizationScoped)}
     */
    @Deprecated
    public <T extends OrganizationScoped> T setOrganizationId(T entity) {
        return setOrganization(entity);
    }

    /**
     * @deprecated Use {@link #setOrganization(OrganizationScoped, UUID)}
     */
    @Deprecated
    public <T extends OrganizationScoped> T setOrganizationId(T entity, UUID organizationId) {
        return setOrganization(entity, organizationId);
    }

    /**
     * Validates that an entity belongs to the current organization.
     * Useful for update/delete operations to prevent cross-organization data manipulation.
     *
     * @param entity the entity to validate
     * @param <T> entity type
     * @throws IllegalStateException if organization IDs don't match
     */
    public <T extends OrganizationScoped> void validateOrganizationMatch(T entity) {
        if (entity == null) {
            throw new IllegalArgumentException("Entity cannot be null");
        }

        UUID currentOrgId = OrganizationContext.getCurrentOrganizationId();
        UUID entityOrgId = entity.getOrganizationId();

        if (entityOrgId == null) {
            throw new IllegalStateException("Entity does not have organization ID set");
        }

        if (!currentOrgId.equals(entityOrgId)) {
            log.error("Organization mismatch: current={}, entity={}, entityType={}",
                currentOrgId, entityOrgId, entity.getClass().getSimpleName());
            throw new IllegalStateException(
                "Entity belongs to different organization. Operation not allowed."
            );
        }

        log.debug("Organization match validated: orgId={}, entityType={}",
            currentOrgId, entity.getClass().getSimpleName());
    }

    /**
     * Checks if an entity belongs to the current organization without throwing exception.
     *
     * @param entity the entity to check
     * @param <T> entity type
     * @return true if entity belongs to current organization
     */
    public <T extends OrganizationScoped> boolean belongsToCurrentOrganization(T entity) {
        if (entity == null || entity.getOrganizationId() == null) {
            return false;
        }

        UUID currentOrgId = OrganizationContext.getCurrentOrganizationIdOrNull();
        if (currentOrgId == null) {
            return false;
        }

        return currentOrgId.equals(entity.getOrganizationId());
    }




    ///facture service 
    ///  @Transactional(readOnly = true)
    public byte[] genererPdfFacture(UUID factureId) {
        log.info("Génération du PDF pour la facture: {}", factureId);

        Facture facture = factureRepository.findById(factureId)
                .orElseThrow(() -> new IllegalArgumentException("Facture non trouvée: " + factureId));

        Client client = clientRepository.findById(facture.getIdClient())
                .orElseThrow(() -> new IllegalArgumentException("Client non trouvé: " + facture.getIdClient()));

        return pdfGeneratorService.generateFacturePdf(facture, client);
    }

    /**
     * Génère et sauvegarde le PDF d'une facture
     */
    @Transactional
    public String genererEtSauvegarderPdfFacture(UUID factureId) {
        log.info("Génération et sauvegarde du PDF pour la facture: {}", factureId);

        Facture facture = factureRepository.findById(factureId)
                .orElseThrow(() -> new IllegalArgumentException("Facture non trouvée: " + factureId));

        Client client = clientRepository.findById(facture.getIdClient())
                .orElseThrow(() -> new IllegalArgumentException("Client non trouvé: " + facture.getIdClient()));

        String pdfPath = pdfGeneratorService.generateAndSaveFacturePdf(facture, client);

        // Mettre à jour le chemin du PDF dans la facture
        facture.setPdfPath(pdfPath);
        factureRepository.save(facture);

        return pdfPath;
    }

    /**
     * Envoie la facture par email au client
     */
    @Transactional
    public void envoyerFactureParEmail(UUID factureId) {
        log.info("Envoi de la facture {} par email", factureId);

        Facture facture = factureRepository.findById(factureId)
                .orElseThrow(() -> new IllegalArgumentException("Facture non trouvée: " + factureId));

        if (facture.getEmailClient() == null || facture.getEmailClient().isEmpty()) {
            throw new IllegalArgumentException("Le client n'a pas d'adresse email");
        }

        Client client = clientRepository.findById(facture.getIdClient())
                .orElseThrow(() -> new IllegalArgumentException("Client non trouvé: " + facture.getIdClient()));

        // Générer le PDF
        byte[] pdfBytes = pdfGeneratorService.generateFacturePdf(facture, client);

        // Envoyer l'email avec le PDF en pièce jointe
        emailService.sendFactureCreationEmail(facture, facture.getEmailClient(), pdfBytes);

        // Mettre à jour le statut d'envoi
        facture.setEnvoyeParEmail(true);
        facture.setDateEnvoiEmail(java.time.LocalDateTime.now());
        factureRepository.save(facture);

        log.info("Facture {} envoyée par email à {}", facture.getNumeroFacture(), facture.getEmailClient());
    }